#!/bin/sh
set -eu
cd $(dirname $0)

backends="py27 py34"
frontends="node6 node7"

autogenerated() {
    echo "### AUTOGENERATED - DO NOT EDIT"
    if [ -n "${1:-}" ]
    then echo "### INSTEAD EDIT THE FILE $1"
    else echo "### RUN THIS TO GENERATE: ./web/generate"
    fi
}

readme() {
    name=$1
    cat - <<EOF
# \`unit9/$name\`

Autogenerated readme and Dockerfile. Please refer here for details:

<https://github.com/unit9/docklabs/tree/master/web>
EOF
}

gen() {
    parts="$@"
    name=web-$(echo $parts | tr ' ' '-')
    dir=images/$name
    fparts=$({
                set -eu
                echo parts/Dockerfile-header
                for p in $parts
                do echo parts/Dockerfile-$p
                done
                echo parts/Dockerfile-footer
            } | tr '\n' ' ')

    mkdir -p $dir
    {
        for fname in $fparts
        do
            autogenerated $fname
            cat $fname
        done
        autogenerated
    } > ${dir}/Dockerfile

    readme $name > ${dir}/readme.md

    for p in $parts
    do
        if test -x parts/run-$p
        then
            cp parts/run-$p ${dir}/run
            return 0
        fi
    done
    echo >&2 "E: no runfile: $name"
    return 1
}

main() {
    rm -rf images
    for p in $backends $frontends
    do gen $p || continue
    done

    for b in $backends
    do for f in $frontends
       do gen $b $f || continue
       done
    done
}

main
